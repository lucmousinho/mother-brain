# Production Readiness Review — Mother Brain
# Reviewed by: Cursor Agent (2026-02-19)
# 57 source files + 10 test files analyzed

## Summary: 3 CRITICAL, 8 HIGH, 8 MEDIUM, 6 LOW

## CRITICAL

### 1. LanceDB Filter Injection (lancedb.store.ts:80,101-108)
All LanceDB filter clauses use raw string interpolation. User input flows from query params directly into filters without sanitization. A `doc.id` containing a single quote breaks the query.

### 2. snapshot.ts Ignores Scope (snapshot.ts:22-27)
Queries ALL nodes and runs with no context_id filter. Cross-tenant data leak.

### 3. Zero API/HTTP Integration Tests
No test covers routes.ts or server.ts. Auth middleware, error responses, request parsing — all untested.

## HIGH

### 4. compact.ts Ignores Context (compact.ts:43-45,86)
Compaction queries by timestamp only, mixing runs from all contexts. Pattern node upserted without explicit contextId.

### 5. upsertNode Doesn't Resolve Context Names to IDs (tree.ts:35)
Unlike checkpoint.ts which has resolveContextId(), tree.ts uses resolveContext() which does NOT call getContextByName(). Nodes stored with literal names instead of IDs.

### 6. deleteContext Has No API Route (routes.ts - missing)
Function fully implemented in context.manager.ts with safety guards, but no DELETE /contexts/:id route registered.

### 7. Auth Disabled by Default (server.ts:13-14)
If MB_TOKEN not set, entire API is unauthenticated. setup command doesn't set token by default.

### 8. Token Comparison Not Timing-Safe (server.ts:21)
Uses === instead of crypto.timingSafeEqual().

### 9. /recall Route Has No try/catch (routes.ts:83-106)
Database errors produce raw 500 with stack trace.

### 10. File Lock TOCTOU Race Condition (filelock.ts:12-23)
Between existsSync + unlinkSync and writeFileSync, another process can acquire the lock.

### 11. No Tests for compact, snapshot, client SDK, OpenClaw adapter

## MEDIUM

### 12. GET /contexts/:id Only Looks Up by ID (routes.ts:183)
Inconsistent with other endpoints that accept name-or-ID.

### 13. getNode() Has No Scope Check (tree.ts:81-88)
Any caller with a node ID can read any node regardless of context.

### 14. Shell Injection in enable.ts (enable.ts:42)
flags.branch interpolated directly into shell command.

### 15. No Rate Limiting on API (server.ts)

### 16. compact.ts Crashes on Malformed JSON (compact.ts:34)
Single malformed file crashes entire compaction.

### 17. Unbounded Embedding Cache (embeddings.cache.ts:3)
No size limit, no eviction. Grows indefinitely in long-running process.

### 18. No Tests for filelock, tree.ts, scope.guard, semantic recall

## LOW

### 19. Duplicate resolveToId/resolveContextId (scope.guard.ts:10, checkpoint.ts:17)
Should be single shared utility.

### 20. No API Routes for compact/snapshot

### 21. No CORS Configuration (server.ts)

### 22. ReDoS Potential in Policy Regex (policy.ts:38)

### 23. Silent Error Swallowing in Vector Indexing (tree.ts:70, checkpoint.ts:98)

### 24. /contexts GET Has No Error Handling (routes.ts:147-155)

### 25. Stale VectorDoc Type Assertion in Test (lancedb.store.test.ts:37-48)

## Priority Fix Order
1. LanceDB filter injection (CRITICAL - security)
2. Scope filtering in snapshot/compact (CRITICAL - data leak)
3. Name→ID resolution in upsertNode (HIGH - data integrity)
4. DELETE /contexts/:id route (HIGH - completeness)
5. try/catch on /recall (HIGH - stability)
6. Timing-safe token comparison (HIGH - security)
7. API integration tests (CRITICAL - confidence)
